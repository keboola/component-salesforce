# Salesforce Writer
=============

The component takes files from in/tables directory and insert/upsert/update/delete appropriate records. The input table
must have a header with field names, which has to exist in Salesforce. ID column is used to identify record which will
be updated. When inserting records all required fields has to be filled in.

**Important Notes:**
- The process can fail on any records (due to missing required field or too large string) and this specific record will not be inserted/updated/upserted/deleted
- There is no way how to rollback this transaction, so you have to carefully check the log each time
- It is recommended to include a column with external IDs and based on them do upsert later
- External IDs will also save you from duplicated records when running insert several times

**Table of contents:**

- [Prerequisites](#prerequisites)
- [Configuration](#configuration)
  - [Authorization configuration](#authorization-configuration)
  - [Row configuration](#row-configuration)
- [Sample Configuration](#sample-configuration)
- [Output](#output)
- [Development](#development)
- [Integration](#integration)

Prerequisites
=============
To get your Salesforce credentials:

1. Log into your Salesforce platform
2. Click on your profile icon in the top right corner
3. Select "Settings"
4. In the Quick Find box, enter "Reset"
5. Select "Reset My Security Token"
6. Click "Reset Security Token"
7. The new security token will be sent to the email address specified in your Salesforce personal settings

**Important Notes:**
- Security token is required when accessing Salesforce via API from an IP address that's not in your company's trusted IP range
- You cannot reset your security token if:
  - Login IP ranges are set for your user profile
  - You have the API Only user permission
  - You have the Multi-Factor Authentication for API Logins user permission (in this case, use the code generated by an authenticator app)
- If you don't see the option to reset your security token, contact your Salesforce admin

For more information follow [this guide from Salesforce](https://help.salesforce.com/s/articleView?id=sf.user_security_token.htm&type=5)

Configuration
=============

Authorization configuration
---------------------------

- User Name (#username) - [REQ] your user name, when exporting data from sandbox don't forget to add .sandboxname at the end
- Password (#password) - [REQ] your password
- Security Token (#security_token) - [REQ] your security token, don't forget it is different for sandbox
- Sandbox (sandbox) - [REQ] true when you want to push data to sandbox
- Use Proxy (use_proxy) - [OPT] Section where you can configure https proxy
  - Proxy Server (proxy_server) - [REQ if Use Proxy is selected] HTTPS Proxy Server Address
  - Proxy Port (port) - [REQ] Proxy Server Port
  - Proxy Username (username) - [OPT] Proxy Server Username
  - Proxy Password (#password) - [OPT] Proxy Server Password
  - Use HTTP proxy for HTTPS (use_http_proxy_for_https) - [OPT] This is a hidden configuration option for a type of HTTP proxy that also handles HTTPS.

Row configuration
---------------

- Object (object) - [REQ] name of object you wish to perform the operation on
- Upsert Field (upsertField) - [REQ for upsert] required when the operation is upsert, in case you have no external ID, you must set it up, or use insert and update operations separately to perform the upsert.
- Operation (operation) - [REQ] specify the operation you wish to do. Insert/Upsert/Update/Delete are supported.
- Serial Mode (serialMode) - [OPT] true if you wish to run the import in serial mode.
- Assignment Rule ID (assignment_rule_id) - [OPT] ID of Lead [Assignment rule](https://help.salesforce.com/s/articleView?id=sf.customize_leadrules.htm&language=en_US&type=5) you want to run after import.
- Replace String (replaceString) - [OPT] string to be replaced in column name for dot, so you can use that column as reference to other record via external id
- Fail on Error (fail_on_error) - [OPT] if you want the job to fail on any error, set this to true and the job will fail if more than 0 errors occur during the execution.

**Important Notes:**
- When inserting you cannot specify ID field
- When updating the ID field in CSV file is required
- When deleting, keep in mind that Salesforce's recycle bin can take less records than you are trying to delete, so they will be hard deleted
- When deleting, the CSV file must contain only ID field

**Note:** The component processes all records on the input and outputs tables containing the failed records with reason of failure. The table names are constructed as `{OBJECT_NAME}_{LOAD_TYPE}_unsuccessful` e.g. `Contact_upsert_unsuccessful`

Sample Configuration
=============

```json
{
  "parameters": {
    "#username": "your_username",
    "#password": "your_password",
    "#security_token": "your_security_token",
    "sandbox": false,
    "proxy": {
      "use_proxy": true,
      "proxy_server": "proxy_server_ip e.g. 44.67.126.78",
      "username": "user",
      "#password": "your_password",
      "port": "8080"
    },
    "rows": [
      {
        "object": "Contact",
        "operation": "upsert",
        "upsertField": "ExternalId__c",
        "serialMode": true,
        "fail_on_error": true
      }
    ]
  },
  "action": "run"
}
```

Output
======

The component will process all records and create output tables for failed records with the naming convention:
`{OBJECT_NAME}_{LOAD_TYPE}_unsuccessful` e.g. `Contact_upsert_unsuccessful`

Development
-----------

If required, change local data folder (the `CUSTOM_FOLDER` placeholder) path to your custom path in
the `docker-compose.yml` file:

```yaml
volumes:
  - ./:/code
  - ./CUSTOM_FOLDER:/data
```

Clone this repository, init the workspace and run the component with following command:

```bash
docker-compose build
docker-compose run --rm dev
```

Run the test suite and lint check using this command:

```bash
docker-compose run --rm test
```

Integration
===========

For information about deployment and integration with KBC, please refer to the
[deployment section of developers documentation](https://developers.keboola.com/extend/component/deployment/)



